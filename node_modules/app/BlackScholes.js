// CND and value functions from: http://cseweb.ucsd.edu/~goguen/courses/130/SayBlackScholes.html
var is_array = requires('app/is_array');

var BlackScholes = function(call_put_flag, X, r, v, T, V=0) {
// call_put_flag: 'c' or anything else for put
// This T is the maturity date (compare to t in value function)
// X: strike
// r: interest rates
// v: volatility
// V: market value

  if(["C","P","S"].indexOf(call_put_flag)==-1) throw("Unsupported call_put_flag=call_put_flag");
  this.call_put_flag=call_put_flag;
  this.X=X;
  this.r=r;
  this.v=v;
  this.T=T;
  this.V=V;
};

BlackScholes.prototype.CND = function(x) {
  var Pi = 3.141592653589793238;
  var a1 = 0.319381530;
  var a2 = -0.356563782;
  var a3 = 1.781477937;
  var a4 = -1.821255978;
  var a5 = 1.330274429;
  var L = abs(x);
  var k = 1 / ( 1 + 0.2316419 * L);
  var p = 1 - 1 /  Math.pow(2 * Pi, 0.5) * exp( -Math.pow(L, 2) / 2 ) * (a1 * k + a2 * Math.pow(k, 2)
       + a3 * Math.pow(k, 3) + a4 * Math.pow(k, 4) + a5 * Math.pow(k, 5) );
  if (x >= 0) { 
    return p;
  } else {
    return 1-p;
  }
}

BlackScholes.prototype.value = function(S, t) {
// t: physical time
  var o={};
  if(this.call_put_flag=="S") {
    for(S as Si) o[S[Si]]=S[Si];
    return o;
  }
  if(is_array(S)) {
    for(S as Si) o[S[Si]]=this.value(S[Si],t);
    return o;
  }
  if(is_array(t)) {
    for(t as ti) o[t[ti]]=this.value(S,t[ti]);
    return o;
  }

  var Tmt=this.T-t;
  if(Tmt==0) return this.value0(S);
  if(Tmt<0) return 0; // expired

  var d1 = ( Math.log(S / this.X) + (this.r + Math.pow(this.v, 2) / 2) * Tmt ) / ( this.v * Math.pow(Tmt, 0.5) );
  var d2 = d1 - this.v * Math.pow(Tmt, 0.5);
  if (this.call_put_flag == 'C') {
    return S * this.CND(d1) - this.X * exp( -this.r * Tmt ) * this.CND(d2) - this.V;
  } else { 
    return this.X * exp( -this.r * Tmt ) * this.CND(-d2) - S * this.CND(-d1) - this.V;
  }
}

BlackScholes.prototype.value0 = function(S) {
  if (this.call_put_flag == 'C') {
    return Math.max(S - this.X, 0) - this.V;
  } else { 
    return Math.max(this.X - S, 0) - this.V;
  }
}

BlackScholes.prototype.id = function() {
  return "".this.call_put_flag."_".this.X."_".this.r."_".this.v."_".this.T; // not appending V here because V is the market value, and it should be the same for both options if they are similar
}

} // end class
