'use strict';
var OptionsStrategy = require('app/OptionsStrategy');
var BlackScholes = require('app/BlackScholes');

module.exports.margin = function (event,context) {
    // event: { portfolio: ..., S: ..., Tmt: ... }
    // portfolio: [{ "q":  1, "t":"C", "X":80, "r":0, "v":0.25, "T":0}, { "q": -1, "t":"S", "X":80, "r":0, "v":0.25, "T":0}]
    // S: 60 or [60,80,100,120]
    // Tmt: 0 or [0,0.1,0.2]
    //
    // Use the following URL to use the API endpoint
    // https://v029nrk9h7.execute-api.us-west-2.amazonaws.com/prod/opstratvis-margin?portfolio=[%7B"q":1,"t":"C","X":80,"r":0,"v":0.25,"T":0%7D,%7B"q":-1,"t":"S","X":80,"r":0,"v":0.25,"T":0%7D]&S=[60,80,100,120]&Tmt=0

    // input validation
    if(!event.hasOwnProperty("portfolio")||!event.hasOwnProperty("S")||!event.hasOwnProperty("Tmt")) {
      context.fail("Invalid parameters passed");
      return;
    }
    var invalidPortfolio=false;
    event.portfolio.forEach(function(x) {
      if(!x.hasOwnProperty("q")||
        !x.hasOwnProperty("t")||
        !x.hasOwnProperty("X")||
        !x.hasOwnProperty("r")||
        !x.hasOwnProperty("v")||
        !x.hasOwnProperty("T")) invalidPortfolio = true;
      });
    if(invalidPortfolio) {
      context.fail("Invalid portfolio passed");
      return;
    }

    try {
      var p2 = event.portfolio.map(function(x) {
        return {
          q: x.q,
          o: new BlackScholes(
            x.t, x.X, x.r, x.v, x.T,
            x.hasOwnProperty("V")?x.V:undefined
          )
        };
      });
      var bs1=new OptionsStrategy(p2);
      var x=bs1.margin(event.S,event.Tmt);
      context.succeed(x);
    } catch(ex) {
      if(ex.hasOwnProperty("message")) ex = ex.message;
      if(ex.hasOwnProperty("errorMessage")) ex = ex.errorMessage;
      context.fail(ex);
    }
};

